# =============================================================================
# Local Development Docker Compose Configuration
# Renewable Energy IoT Monitoring System
# =============================================================================
# 
# This file is for LOCAL DEVELOPMENT on Windows.
# Uses standard ports for easy development and testing.
# 
# Usage: docker-compose -f docker-compose.local.yml up -d
# =============================================================================

services:
  # MQTT Broker - Eclipse Mosquitto
  mosquitto:
    image: eclipse-mosquitto:2.0.18
    container_name: iot-mosquitto-local
    ports:
      - "1883:1883"      # MQTT (standard port)
      - "9001:9001"      # WebSocket (standard port)
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    environment:
      - TZ=UTC
      - MOSQUITTO_CONFIG_FILE=/mosquitto/config/mosquitto.conf
      - MOSQUITTO_PASSWORD_FILE=/mosquitto/config/passwd
      - MOSQUITTO_ACL_FILE=/mosquitto/config/acl
      - MOSQUITTO_LOG_LEVEL=information
      - MOSQUITTO_MAX_CONNECTIONS=1000
      - MOSQUITTO_MAX_QUEUED_MESSAGES=100
      - MOSQUITTO_AUTOSAVE_INTERVAL=1800
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mosquitto_pub", "-h", "localhost", "-u", "admin", "-P", "admin_password_456", "-t", "system/health/mosquitto", "-m", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - iot-network-local

  # Time-Series Database - InfluxDB 2.x
  influxdb:
    image: influxdb:2.7
    container_name: iot-influxdb2-local
    expose:
      - "8086"      # InfluxDB (exposed internally for nginx)
    volumes:
      - ./influxdb/data:/var/lib/influxdb2
      - ./influxdb/backups:/backups
    environment:
      # Time Zone
      - TZ=UTC
      
      # Authentication & Access (disabled for local development)
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=admin_password_123
      - INFLUXDB_ADMIN_TOKEN=renewable_energy_admin_token_123
      - INFLUXDB_HTTP_AUTH_ENABLED=false
      
      # Database Configuration
      - INFLUXDB_DB=renewable_energy
      - INFLUXDB_ORG=renewable_energy_org
      - INFLUXDB_BUCKET=renewable_energy
      - INFLUXDB_RETENTION=30d
      
      # Initial Setup
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin_password_123
      - DOCKER_INFLUXDB_INIT_ORG=renewable_energy_org
      - DOCKER_INFLUXDB_INIT_BUCKET=renewable_energy
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=renewable_energy_admin_token_123
      - DOCKER_INFLUXDB_INIT_RETENTION=30d
      - INFLUXDB_REPORTING_DISABLED=true
      - INFLUXDB_META_DIR=/var/lib/influxdb2/meta
      
      # Performance & Storage
      - INFLUXDB_DATA_DIR=/var/lib/influxdb2/data
      - INFLUXDB_WAL_DIR=/var/lib/influxdb2/wal
      - INFLUXDB_ENGINE_PATH=/var/lib/influxdb2/engine
      - INFLUXDB_MAX_CONCURRENT_COMPACTIONS=0
      
      # HTTP Configuration
      - INFLUXDB_HTTP_BIND_ADDRESS=:8086
      - INFLUXDB_HTTP_PORT=8086
      - INFLUXDB_HTTP_MAX_CONNECTION_LIMIT=0
      - INFLUXDB_HTTP_READ_TIMEOUT=30s
      
      # Logging & Monitoring
      - INFLUXDB_LOGGING_LEVEL=info
      - INFLUXDB_LOGGING_FORMAT=auto
      - INFLUXDB_METRICS_DISABLED=true
      - INFLUXDB_PPROF_ENABLED=false
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8086/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - iot-network-local

  # Data Processing - Node-RED
  node-red:
    image: nodered/node-red:latest
    container_name: iot-node-red-local
    expose:
      - "1880"      # Node-RED (exposed internally for nginx)
    volumes:
      - ./node-red/data:/data
      - ./node-red/settings.local.js:/data/settings.js
      - ./node-red/package.json:/data/package.json
      - ./node-red/startup.sh:/startup.sh
    environment:
      - TZ=UTC
      - NODE_RED_ENABLE_PROJECTS=true
      - NODE_RED_EDITOR_THEME=dark
      - NODE_RED_DISABLE_EDITOR=false
      - NODE_RED_DISABLE_FLOWS=false
      - NODE_RED_HOME=/data
      - NODE_RED_OPTIONS=--max-old-space-size=512
      - NODE_RED_SETTINGS_FILE=/data/settings.js
      - NODE_RED_CREDENTIAL_SECRET=your-node-red-secret
      # Node-RED Authentication
      - NODE_RED_USERNAME=admin
      - NODE_RED_PASSWORD=adminpassword
      # Node-RED InfluxDB Integration
      - NODE_RED_INFLUXDB_URL=http://influxdb:8086
      - NODE_RED_INFLUXDB_ORG=renewable_energy_org
      - NODE_RED_INFLUXDB_BUCKET=renewable_energy
      - NODE_RED_INFLUXDB_TOKEN=renewable_energy_admin_token_123
      - INFLUXDB_TOKEN=renewable_energy_admin_token_123
    restart: unless-stopped
    depends_on:
      mosquitto:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:1880/nodered/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    entrypoint: ["/bin/bash", "/startup.sh"]
    networks:
      - iot-network-local

  # Visualization - Grafana
  grafana:
    image: grafana/grafana:10.2.0
    container_name: iot-grafana-local
    expose:
      - "3000"      # Grafana (exposed internally for nginx)
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
      - ./grafana/plugins:/var/lib/grafana/plugins
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
      - GF_SECURITY_COOKIE_SECURE=false
      - GF_SERVER_ROOT_URL=http://localhost:8080/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
      - GF_LOG_LEVEL=info
    restart: unless-stopped
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - iot-network-local

  # API Backend - Express.js (Local Development)
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: iot-api-local
    expose:
      - "3001"      # API (exposed internally for nginx)
    environment:
      - NODE_ENV=development
      - PORT=3001
      - TZ=UTC
      # InfluxDB Configuration
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_ORG=renewable_energy_org
      - INFLUXDB_BUCKET=renewable_energy
      - TEST_TOKEN=renewable_energy_admin_token_123
      # CORS Configuration
      - CORS_ORIGIN=http://localhost:8080,http://localhost:3002,http://localhost:5173
    volumes:
      - ./api/src:/app/src:ro
      - ./api/public:/app/public:ro
    restart: unless-stopped
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - iot-network-local

  # Frontend - React with Vite (Local Development)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NODE_ENV=development
        - VITE_API_URL=http://localhost:8080/api
        - VITE_API_BASE_URL=http://localhost:8080/api
    container_name: iot-frontend-local
    expose:
      - "80"      # Frontend (exposed internally for nginx)
    environment:
      - NODE_ENV=development
      - TZ=UTC
      # API Configuration
      - VITE_API_URL=http://localhost:8080/api
      - VITE_API_BASE_URL=http://localhost:8080/api
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://127.0.0.1:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - iot-network-local

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: iot-nginx-local
    ports:
      - "8080:80"      # Nginx (single entry point for all services)
    volumes:
      - ./nginx/nginx.local.conf:/etc/nginx/nginx.conf:ro
    restart: unless-stopped
    depends_on:
      grafana:
        condition: service_healthy
      node-red:
        condition: service_healthy
      influxdb:
        condition: service_healthy
      api:
        condition: service_healthy
      frontend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - iot-network-local

networks:
  iot-network-local:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  mosquitto_data_local:
    driver: local
  mosquitto_log_local:
    driver: local
  influxdb_data_local:
    driver: local
  node_red_data_local:
    driver: local
  grafana_data_local:
    driver: local
