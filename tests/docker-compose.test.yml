services:
  test-runner:
    image: node:18-alpine
    container_name: iot-test-runner
    environment:
      # Test environment
      - NODE_ENV=test
      
      # Service connections
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - MQTT_USERNAME=${MQTT_ADMIN_USER:-admin}
      - MQTT_PASSWORD=${MQTT_ADMIN_PASSWORD:-admin_password_456}
      
      - NODE_RED_HOST=node-red
      - NODE_RED_PORT=1880
      - NODE_RED_USERNAME=admin
      - NODE_RED_PASSWORD=adminpassword
      
      - INFLUXDB_HOST=influxdb
      - INFLUXDB_PORT=8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-renewable-energy}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-iot-data}
      
      - GRAFANA_HOST=grafana
      - GRAFANA_PORT=3000
      - GRAFANA_USERNAME=${GRAFANA_ADMIN_USER:-admin}
      - GRAFANA_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      
      # Test configuration
      - TEST_TIMEOUT=30000
      - TEST_RETRIES=3
      - TEST_DELAY=1000
      
    volumes:
      - ./javascript:/app/javascript
      - ./config:/app/config
      - ./test-results:/app/test-results
      - ./package.json:/app/package.json
      - ./jest.setup.js:/app/jest.setup.js
      
    working_dir: /app
      
    networks:
      - iot-network
      
    restart: "no"
    
    # Simple: install and run all tests
    command: sh -c "npm install && npm test"

networks:
  iot-network:
    external: true
    name: plat-edu-bad-data-mvp_iot-network
